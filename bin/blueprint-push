#!/usr/bin/python

import logging
import optparse
import re
import sys

import blueprint
import blueprint_io
from blueprint_io import cfg

parser = optparse.OptionParser('Usage: %prog [-s <secret>] [-q] <name>')
parser.add_option('-s', '--secret',
                  dest='secret',
                  default=None,
                  help='operate quietly')
parser.add_option('-q', '--quiet',
                  dest='quiet',
                  default=False,
                  action='store_true',
                  help='operate quietly')
options, args = parser.parse_args()

if options.quiet:
    logging.root.setLevel(logging.CRITICAL)

if 1 != len(args):
    parser.print_usage()
    sys.exit(1)
name = args[0]

try:
    b = blueprint.Blueprint(name=name)
except KeyError:
    logging.error('blueprint {0} does not exist'.format(name))
    sys.exit(1)
except ValueError:
    logging.error('invalid blueprint name')
    sys.exit(1)

secret = options.secret or cfg.secret() or blueprint_io.secret()
if secret is None:
    sys.exit(1)
url = blueprint_io.push(secret, b)
if url is not None:
    print(url)
